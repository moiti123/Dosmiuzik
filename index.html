<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Windows Music Station</title>
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&family=Segoe+UI&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.70);
            --glass-strong: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.4);
            --primary: #0078d4;
            --text: #202020;
            --danger: #e81123;
            --radius: 8px;
        }

        [data-theme="dark"] {
            --glass-bg: rgba(32, 32, 32, 0.85);
            --glass-strong: rgba(45, 45, 45, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1);
            --primary: #60cdff;
            --text: #ffffff;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Segoe UI', 'Heebo', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* רקע מתחלף */
        body[data-theme="dark"] {
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
        }

        /* כותרת עליונה */
        header {
            flex: 0 0 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            background: var(--glass-bg);
            border-bottom: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
        }

        .widget-area { display: flex; gap: 15px; align-items: center; font-size: 0.9rem; }
        .time-big { font-weight: 800; font-size: 1.4rem; color: var(--primary); }

        /* אזור תוכן ראשי - מחולק ל-2 */
        .main-split {
            flex: 1;
            display: flex;
            padding: 15px;
            gap: 15px;
            overflow: hidden;
        }

        /* פאנל כללי */
        .panel {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        .panel-header {
            padding: 15px;
            font-weight: 700;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--glass-strong);
        }

        /* --- צד ימין: רדיו --- */
        .radio-section { flex: 1; min-width: 300px; }
        
        /* נגן מותאם אישית */
        .custom-player {
            padding: 20px;
            text-align: center;
            background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(255,255,255,0));
        }

        .status-badge {
            display: inline-block;
            background: var(--danger);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-bottom: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .status-badge.on { opacity: 1; animation: pulse 2s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .player-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .play-btn {
            width: 60px; height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.1s;
            display: flex; align-items: center; justify-content: center;
        }
        .play-btn:active { transform: scale(0.95); }

        /* סליידר ווליום */
        .volume-control { display: flex; align-items: center; gap: 10px; width: 120px; }
        input[type=range] {
            width: 100%; height: 4px; border-radius: 2px;
            background: #ddd; outline: none; -webkit-appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 16px; height: 16px;
            background: var(--primary); border-radius: 50%; cursor: pointer;
        }

        /* רשימת ערוצים */
        .channels-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .channel-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 5px;
            background: var(--glass-strong);
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.2s;
        }
        .channel-item:hover { background: rgba(255,255,255,0.5); }
        .channel-item.active { border-color: var(--primary); background: rgba(0, 120, 212, 0.1); }
        
        .delete-btn { color: #aaa; padding: 5px; }
        .delete-btn:hover { color: var(--danger); }

        /* הוספת ערוץ */
        .add-channel-box {
            padding: 10px;
            border-top: 1px solid var(--glass-border);
            display: flex; gap: 5px;
            background: var(--glass-strong);
        }

        /* --- צד שמאל: יוטיוב --- */
        .youtube-section { flex: 1.5; }
        
        .yt-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 10px;
            overflow: hidden;
        }

        .video-container {
            width: 100%;
            flex: 1; /* תופס את כל הגובה הפנוי */
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        iframe { width: 100%; height: 100%; border: none; }

        /* אינפוטים כלליים */
        .win-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            font-family: inherit;
        }

        /* פוטר חדשות */
        .ticker-wrap {
            flex: 0 0 30px;
            background: var(--danger);
            color: white;
            overflow: hidden;
            white-space: nowrap;
            line-height: 30px;
            font-size: 0.9rem;
            position: relative;
        }
        .ticker-move { display: inline-block; padding-left: 100%; animation: ticker 25s linear infinite; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(100%, 0, 0); } }

        /* מובייל */
        @media (max-width: 800px) {
            .main-split { flex-direction: column; overflow-y: auto; }
            .radio-section, .youtube-section { min-height: 400px; flex: none; }
            body { overflow-y: auto; }
        }
    </style>
</head>
<body>

<header>
    <div class="widget-area">
        <div class="time-big" id="clock">00:00</div>
        <div>
            <div id="hebrewDate">טוען תאריך...</div>
            <div id="weatherInfo" style="font-size:0.85rem; opacity:0.8;"><i class="fas fa-spinner fa-spin"></i></div>
        </div>
    </div>
    <button onclick="toggleTheme()" style="background:none; border:none; font-size:1.2rem; cursor:pointer; color:var(--text);">
        <i class="fas fa-adjust"></i>
    </button>
</header>

<div class="main-split">
    
    <div class="panel radio-section">
        <div class="panel-header">
            <span><i class="fas fa-broadcast-tower"></i> נגן רדיו</span>
        </div>

        <div class="custom-player">
            <div id="liveIndicator" class="status-badge">LIVE</div>
            <h3 id="currentChannelName" style="margin: 5px 0;">בחר ערוץ</h3>
            <div style="font-size:0.8rem; opacity:0.7;">Streaming Audio</div>
            
            <div class="player-controls">
                <div class="volume-control">
                    <i class="fas fa-volume-down"></i>
                    <input type="range" min="0" max="1" step="0.1" value="1" oninput="setVolume(this.value)">
                </div>

                <button class="play-btn" onclick="togglePlay()" id="mainPlayBtn">
                    <i class="fas fa-play"></i>
                </button>
                
                <div style="width: 40px;"></div> </div>
        </div>

        <div class="channels-list" id="channelsList">
            </div>

        <div class="add-channel-box">
            <input type="text" id="newChName" class="win-input" placeholder="שם ערוץ">
            <input type="text" id="newChUrl" class="win-input" placeholder="קישור (m3u8)">
            <button onclick="addUserChannel()" style="background:var(--primary); color:white; border:none; padding:0 10px; border-radius:4px;">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>

    <div class="panel youtube-section">
        <div class="panel-header">
            <span><i class="fab fa-youtube"></i> וידאו ופלייליסטים</span>
        </div>
        
        <div class="yt-wrapper">
            <div style="display:flex; gap:5px;">
                <input type="text" id="ytSearch" class="win-input" placeholder="חפש שיר או אמן...">
                <button onclick="playYoutube(document.getElementById('ytSearch').value)" style="background:var(--primary); color:white; border:none; padding:0 15px; border-radius:4px;">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <div id="ytTags" style="display:flex; gap:5px; overflow-x:auto; padding-bottom:5px;"></div>

            <div class="video-container">
                <iframe id="youtubeFrame" src="" allowfullscreen></iframe>
            </div>
        </div>
    </div>

</div>

<audio id="audioEngine" style="display:none;"></audio>

<div class="ticker-wrap">
    <div class="ticker-move">
        מבזק: ברוכים הבאים למערכת המולטימדיה החדשה • מזג האוויר: ירידה קלה בטמפרטורות • האזנה ערבה! • עדכוני חדשות שוטפים ניתן לשמוע בערוץ קול חי
    </div>
</div>

<script>
    // --- 1. הגדרות וניהול ערוצים ---
    const defaultChannels = [
        { name: "קול חי מיוזיק", url: "https://live.kcm.fm/26/hls.m3u8" },
        { name: "קול חי - ראשי", url: "https://live.kcm.fm/27/hls.m3u8" },
        { name: "קול פליי", url: "https://live.kcm.fm/28/hls.m3u8" },
        { name: "ערוץ הקצב", url: "https://live.kcm.fm/75/hls.m3u8" },
        { name: "ערוץ הרגש", url: "https://live.kcm.fm/77/hls.m3u8" }
    ];

    // טעינת ערוצים משולבת (ברירת מחדל + משתמש)
    let allChannels = JSON.parse(localStorage.getItem('userChannels')) || [];
    // אם המערך ריק (פעם ראשונה), נכניס את ברירת המחדל
    if(allChannels.length === 0) {
        allChannels = [...defaultChannels];
    }

    const channelsListEl = document.getElementById('channelsList');

    function renderChannels() {
        channelsListEl.innerHTML = '';
        allChannels.forEach((ch, index) => {
            const div = document.createElement('div');
            div.className = 'channel-item';
            div.innerHTML = `
                <span onclick="playChannel(${index})" style="flex:1;">
                    <i class="fas fa-music" style="margin-left:5px; opacity:0.6;"></i> ${ch.name}
                </span>
                ${index >= defaultChannels.length ? `<i class="fas fa-trash delete-btn" onclick="deleteChannel(${index})"></i>` : ''}
            `;
            channelsListEl.appendChild(div);
        });
    }

    // הוספת ערוץ משתמש
    window.addUserChannel = () => {
        const name = document.getElementById('newChName').value;
        const url = document.getElementById('newChUrl').value;
        if(name && url) {
            allChannels.push({name, url});
            localStorage.setItem('userChannels', JSON.stringify(allChannels));
            renderChannels();
            document.getElementById('newChName').value = '';
            document.getElementById('newChUrl').value = '';
        }
    }

    window.deleteChannel = (index) => {
        if(confirm('למחוק ערוץ זה?')) {
            allChannels.splice(index, 1);
            localStorage.setItem('userChannels', JSON.stringify(allChannels));
            renderChannels();
        }
    }

    // --- 2. מנוע האודיו (HLS + ניהול זיכרון) ---
    const audio = document.getElementById('audioEngine');
    const playBtnIcon = document.querySelector('#mainPlayBtn i');
    let hls = null;
    let isPlaying = false;

    // הגדרות HLS לחיסכון בזיכרון (RAM)
    const hlsConfig = {
        maxBufferLength: 30, // שומר רק 30 שניות בבאפר
        maxMaxBufferLength: 60, // מקסימום מוחלט
        liveSyncDurationCount: 3, // שומר על שידור חי קרוב לזמן אמת
        enableWorker: true
    };

    window.playChannel = (index) => {
        const channel = allChannels[index];
        const url = channel.url;
        
        // עדכון UI
        document.getElementById('currentChannelName').innerText = channel.name;
        document.querySelectorAll('.channel-item').forEach(el => el.classList.remove('active'));
        channelsListEl.children[index].classList.add('active');
        document.getElementById('liveIndicator').classList.add('on');

        // איפוס נגן קיים
        if (hls) {
            hls.destroy();
        }

        if (Hls.isSupported()) {
            hls = new Hls(hlsConfig);
            hls.loadSource(url);
            hls.attachMedia(audio);
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                audio.play();
                updatePlayState(true);
            });
            
            // טיפול בשגיאות (למשל אם השידור נתקע)
            hls.on(Hls.Events.ERROR, function (event, data) {
                if (data.fatal) {
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            hls.recoverMediaError();
                            break;
                        default:
                            hls.destroy();
                            break;
                    }
                }
            });

        } else if (audio.canPlayType('application/vnd.apple.mpegurl')) {
            // תמיכה ב-Safari (נייטיב)
            audio.src = url;
            audio.play();
            updatePlayState(true);
        }
    }

    window.togglePlay = () => {
        if (audio.paused) {
            audio.play();
            updatePlayState(true);
        } else {
            audio.pause();
            updatePlayState(false);
        }
    }

    function updatePlayState(playing) {
        isPlaying = playing;
        if(playing) {
            playBtnIcon.className = "fas fa-pause";
            document.getElementById('liveIndicator').classList.add('on');
        } else {
            playBtnIcon.className = "fas fa-play";
            document.getElementById('liveIndicator').classList.remove('on');
        }
    }

    window.setVolume = (val) => {
        audio.volume = val;
    }

    // --- 3. יוטיוב (מופרד לחלוטין) ---
    const iframe = document.getElementById('youtubeFrame');
    
    // תגיות מהירות
    const ytTags = ["חסידי", "מזרחי", "שירי רגש", "חתונות", "ווקאלי"];
    const tagsContainer = document.getElementById('ytTags');
    
    ytTags.forEach(tag => {
        const btn = document.createElement('button');
        btn.innerText = tag;
        btn.style.cssText = "white-space:nowrap; border:none; background:rgba(0,0,0,0.1); padding:5px 10px; border-radius:15px; cursor:pointer;";
        btn.onclick = () => playYoutube(tag);
        tagsContainer.appendChild(btn);
    });

    window.playYoutube = (query) => {
        iframe.src = 'https://www.youtube.com/embed?listType=search&list=' + encodeURIComponent(query);
    }
    
    // --- 4. ווידג'טים (זמן, תאריך, מזג אוויר) ---
    function updateWidgets() {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'});
        
        // המרת תאריך לעברית (פשוטה)
        const dateOptions = { calendar: 'hebrew', day: 'numeric', month: 'long', year: 'numeric' };
        document.getElementById('hebrewDate').innerText = new Intl.DateTimeFormat('he-IL-u-ca-hebrew', dateOptions).format(now);
    }
    setInterval(updateWidgets, 1000);
    updateWidgets();

    // מזג אוויר
    async function getWeather() {
        // ברירת מחדל: ירושלים
        try {
            const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=31.7683&longitude=35.2137&current_weather=true');
            const data = await res.json();
            document.getElementById('weatherInfo').innerText = `ירושלים: ${Math.round(data.current_weather.temperature)}°C`;
        } catch(e) {
            document.getElementById('weatherInfo').innerText = "--";
        }
    }
    getWeather();

    // החלפת נושא
    let isDark = false;
    window.toggleTheme = () => {
        isDark = !isDark;
        document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
    }

    // הפעלה ראשונית
    renderChannels();

</script>
</body>
</html>
