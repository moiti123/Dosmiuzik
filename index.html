<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Windows Music Player</title>
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&family=Segoe+UI&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-strong: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(255, 255, 255, 0.4);
            --primary-accent: #0078d4;
            --text-main: #202020;
            --radius: 10px;
            --ticker-bg: #d63031;
            --ticker-text: #fff;
        }

        [data-theme="dark"] {
            --glass-bg: rgba(30, 30, 30, 0.85);
            --glass-strong: rgba(50, 50, 50, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --primary-accent: #60cdff;
            --ticker-bg: #b71540;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Heebo', sans-serif;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: var(--text-main);
            height: 100vh; /* גובה מסך מלא */
            width: 100vw;
            overflow: hidden; /* ביטול גלילה כללית */
            display: flex;
            flex-direction: column;
        }

        /* רקע דינמי */
        .bg-layer {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: -1;
            background-size: cover;
            background-position: center;
            transition: background 0.5s;
        }

        /* --- מכולה ראשית (Flex Column) --- */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 10px;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
            height: 100%;
        }

        /* --- שורה עליונה: ווידג'ט --- */
        header {
            flex: 0 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--glass-bg);
            padding: 8px 15px;
            border-radius: var(--radius);
            border: 1px solid var(--glass-border);
        }

        .header-controls { display: flex; gap: 10px; }
        .icon-btn { cursor: pointer; padding: 5px; font-size: 1.1rem; }

        .info-widget {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.9rem;
        }
        .time-display { font-weight: 800; font-size: 1.3rem; color: var(--primary-accent); }
        .date-display { font-size: 0.85rem; line-height: 1.1; }

        /* --- אזור מרכזי: מתחלק בין נגן+ערוצים לבין יוטיוב --- */
        .content-wrapper {
            flex: 1;
            display: flex;
            gap: 10px;
            overflow: hidden; /* מונע גלילה החוצה */
        }

        /* צד ימין: נגן וערוצים */
        .side-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 300px;
            overflow-y: auto; /* גלילה פנימית אם צריך */
            scrollbar-width: thin;
        }

        /* כרטיס נגן */
        .player-card {
            background: var(--glass-strong);
            padding: 15px;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        audio { width: 100%; height: 35px; margin-top: 10px; }

        /* גריד ערוצים */
        .channels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
        }
        .channel-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 0.9rem;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .channel-btn:hover { transform: scale(1.02); background: rgba(255,255,255,0.5); }
        .channel-btn.active { background: var(--primary-accent); color: white; border-color: transparent; }

        /* צד שמאל: יוטיוב */
        .youtube-panel {
            flex: 1.5;
            background: var(--glass-bg);
            border-radius: var(--radius);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .yt-controls { display: flex; gap: 5px; }
        .win-input { flex: 1; padding: 5px 10px; border-radius: 5px; border: 1px solid #ccc; }
        .yt-tags { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; white-space: nowrap; }
        .tag-chip { 
            background: var(--glass-strong); padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; cursor: pointer; border: 1px solid var(--glass-border); 
            display: flex; align-items: center; gap: 5px;
        }
        
        .video-container {
            flex: 1;
            background: black;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        iframe { width: 100%; height: 100%; border: none; position: absolute; top:0; left:0; }

        /* --- Footer: חדשות רצות --- */
        .news-ticker-container {
            flex: 0 0 30px; /* גובה קבוע */
            background: var(--ticker-bg);
            color: var(--ticker-text);
            display: flex;
            align-items: center;
            overflow: hidden;
            position: relative;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .ticker-label {
            background: rgba(0,0,0,0.2);
            padding: 0 15px;
            height: 100%;
            display: flex;
            align-items: center;
            z-index: 2;
        }

        .ticker-content {
            display: inline-block;
            padding-right: 100%;
            animation: ticker 30s linear infinite;
        }

        .news-item { margin-left: 50px; display: inline-flex; align-items: center; gap: 5px; }
        .news-item:after { content: "•"; margin-right: 10px; opacity: 0.7; }

        @keyframes ticker {
            0% { transform: translate3d(0, 0, 0); }
            100% { transform: translate3d(100%, 0, 0); } /* RTL direction */
        }

        /* מודאל הגדרות */
        .modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 10px; width: 300px;
            display: flex; flex-direction: column; gap: 10px;
        }

        /* התאמה למובייל (Portrait) */
        @media (max-width: 768px) {
            .content-wrapper { flex-direction: column; overflow-y: auto; }
            .side-panel { min-height: auto; flex: 0 0 auto; }
            .youtube-panel { flex: 1; min-height: 300px; }
            .header-controls { font-size: 0.9rem; }
            .info-widget { font-size: 0.8rem; gap: 8px; }
            body { overflow-y: auto; } /* במובייל קטן כן נאפשר גלילה אם צריך */
        }
    </style>
</head>
<body>

<div class="bg-layer" id="bgLayer"></div>

<div class="main-container">
    <header>
        <div class="info-widget">
            <div class="time-display" id="clock">00:00</div>
            <div class="date-display">
                <div id="hebrewDateText" style="font-weight: bold;">טוען...</div>
                <div id="weatherText"><i class="fas fa-spinner fa-spin"></i></div>
            </div>
        </div>
        
        <div class="header-controls">
            <div class="icon-btn" onclick="openSettings()" title="הגדרות"><i class="fas fa-cog"></i></div>
            <div class="icon-btn" onclick="toggleTheme()" title="מצב לילה"><i class="fas fa-moon"></i></div>
        </div>
    </header>

    <div class="content-wrapper">
        
        <div class="side-panel">
            <div class="player-card">
                <div id="statusText" style="color: var(--primary-accent); font-weight:600; margin-bottom:5px;">בחר ערוץ</div>
                <audio id="audioPlayer" controls></audio>
            </div>

            <div style="font-size: 0.9rem; font-weight: 600; opacity: 0.7;">ערוצי רדיו</div>
            <div class="channels-grid" id="channelsGrid"></div>
        </div>

        <div class="youtube-panel">
            <div class="yt-controls">
                <input type="text" id="newTagName" class="win-input" placeholder="הוסף נושא/זמר...">
                <button onclick="addCustomTag()" style="background:var(--primary-accent); color:white; border:none; border-radius:5px; padding:0 10px;"><i class="fas fa-plus"></i></button>
            </div>
            
            <div class="yt-tags" id="tagsContainer"></div>
            
            <div class="video-container">
                <iframe id="youtubeFrame" src="" allowfullscreen></iframe>
            </div>
        </div>
    </div>
</div>

<div class="news-ticker-container">
    <div class="ticker-label">מבזקים</div>
    <div class="ticker-content" id="newsTicker">
        </div>
</div>

<div class="modal" id="settingsModal">
    <div class="modal-content">
        <h3>הגדרות</h3>
        <label>בחר עיר למזג אוויר:</label>
        <select id="citySelect" class="win-input" onchange="saveCity()">
            <option value="Jerusalem">ירושלים</option>
            <option value="Bnei Brak">בני ברק</option>
            <option value="Tel Aviv">תל אביב</option>
            <option value="Haifa">חיפה</option>
            <option value="Safed">צפת</option>
            <option value="Beersheba">באר שבע</option>
            <option value="Eilat">אילת</option>
            <option value="New York">ניו יורק</option>
        </select>
        <button onclick="document.getElementById('settingsModal').style.display='none'" class="channel-btn" style="margin-top:10px;">סגור</button>
    </div>
</div>

<script>
    // --- 1. ניהול הגדרות ושמירה (Cookies/LocalStorage) ---
    const config = {
        theme: localStorage.getItem('theme') || 'light',
        city: localStorage.getItem('city') || 'Jerusalem',
        tags: JSON.parse(localStorage.getItem('tags')) || ["חסידי מזרחי", "שירי שבת", "מוטי שטיינמץ", "ווקאלי"],
        cityCoords: {
            "Jerusalem": {lat: 31.7683, lon: 35.2137},
            "Bnei Brak": {lat: 32.0849, lon: 34.8352},
            "Tel Aviv": {lat: 32.0853, lon: 34.7818},
            "Haifa": {lat: 32.7940, lon: 34.9896},
            "Safed": {lat: 32.9646, lon: 35.4960},
            "Beersheba": {lat: 31.2518, lon: 34.7913},
            "Eilat": {lat: 29.5581, lon: 34.9482},
            "New York": {lat: 40.7128, lon: -74.0060}
        }
    };

    // --- 2. המרת תאריך עברי לאותיות ---
    const hebrewLetters = ["", "א", "ב", "ג", "ד", "ה", "ו", "ז", "ח", "ט", "י", "י״א", "י״ב", "י״ג", "י״ד", "ט״ו", "ט״ז", "י״ז", "י״ח", "י״ט", "כ", "כ״א", "כ״ב", "כ״ג", "כ״ד", "כ״ה", "כ״ו", "כ״ז", "כ״ח", "כ״ט", "ל"];
    
    function getHebrewYear(yearNum) {
        // המרה פשוטה לשנת תשפ"ה וכו'
        const hebrewYearStr = new Intl.DateTimeFormat('he-IL-u-ca-hebrew', {year:'numeric'}).format(new Date());
        // לעיתים הדפדפן מחזיר "התשפ״ה" ולעיתים מספר. נשתמש בפורמט המובנה של הדפדפן שהוא בדרך כלל מדויק
        return hebrewYearStr.replace(/(\d+)/g, ''); // מסיר מספרים אם יש, משאיר אותיות
    }

    function updateDateTime() {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'});
        
        // המרת יום בחודש לאותיות
        const dayNum = parseInt(new Intl.DateTimeFormat('he-IL-u-ca-hebrew', {day:'numeric'}).format(now));
        const monthName = new Intl.DateTimeFormat('he-IL-u-ca-hebrew', {month:'long'}).format(now);
        const yearStr = new Intl.DateTimeFormat('he-IL-u-ca-hebrew', {year:'numeric'}).format(now).split(' ')[0]; // לוקח את השנה
        
        // יצירת המחרוזת: ג' כסלו התשפ"ה
        const dayLetter = hebrewLetters[dayNum] || dayNum; 
        document.getElementById('hebrewDateText').innerText = `${dayLetter}' ${monthName} ${yearStr}`;
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // --- 3. מזג אוויר לפי בחירה ---
    async function fetchWeather() {
        const coords = config.cityCoords[config.city];
        const cityName = document.querySelector(`#citySelect option[value="${config.city}"]`).text;
        
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current_weather=true`);
            const data = await res.json();
            const temp = Math.round(data.current_weather.temperature);
            
            document.getElementById('weatherText').innerHTML = `<i class="fas fa-cloud"></i> ${cityName}: ${temp}°C`;
        } catch (e) {
            document.getElementById('weatherText').innerText = "שגיאה בטעינת מזג אוויר";
        }
    }

    function openSettings() {
        document.getElementById('settingsModal').style.display = 'flex';
        document.getElementById('citySelect').value = config.city;
    }

    function saveCity() {
        config.city = document.getElementById('citySelect').value;
        localStorage.setItem('city', config.city);
        fetchWeather();
    }
    
    // הפעלה ראשונית
    fetchWeather();
    setInterval(fetchWeather, 600000); // כל 10 דקות

    // --- 4. מבזקי חדשות (סימולציה) ---
    // הערה: לא ניתן למשוך ישירות מאתר הגזרה בגלל חסימת דפדפן (CORS). שמתי כאן דוגמאות.
    const newsItems = [
        "ברוכים הבאים לנגן מיוזיק פלוס - כל המוזיקה במקום אחד",
        "עדכון: נוספו ערוצים חדשים להאזנה ישירה",
        "תחזית מזג האוויר: ירידה קלה בטמפרטורות בסוף השבוע",
        "מוזיקה: האלבום החדש של מוטי שטיינמץ שובר שיאים",
        "חדשות: עדכונים שוטפים ניתן לשמוע בערוץ קול חי ראשי",
        "הגזרה: לכל העדכונים והכתבות הכנסו לאתר הגזרה ניוז"
    ];

    function initTicker() {
        const ticker = document.getElementById('newsTicker');
        let html = '';
        // משכפל את החדשות כדי שזה יראה אינסופי
        const allNews = [...newsItems, ...newsItems];
        allNews.forEach(item => {
            html += `<span class="news-item">${item}</span>`;
        });
        ticker.innerHTML = html;
    }
    initTicker();

    // --- 5. נגן וערוצים (החלק הקיים) ---
    const channels = [
        { id: 27, name: "קול חי ראשי", icon: "fa-microphone" },
        { id: 26, name: "קול חי מיוזיק", icon: "fa-music" },
        { id: 28, name: "קול פליי", icon: "fa-play" },
        { id: 75, name: "ערוץ הקצב", icon: "fa-drum" },
        { id: 77, name: "ערוץ הרגש", icon: "fa-heart" },
        { id: 29, name: "שיעורי תורה", icon: "fa-book" }
    ];

    const audio = document.getElementById('audioPlayer');
    const hls = new Hls();

    channels.forEach(ch => {
        const btn = document.createElement('div');
        btn.className = 'channel-btn';
        btn.innerHTML = `<i class="fas ${ch.icon}"></i><span>${ch.name}</span>`;
        btn.onclick = () => {
            // ניגון
            const url = `https://live.kcm.fm/${ch.id}/hls.m3u8`;
            document.querySelectorAll('.channel-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('statusText').innerText = "מנגן: " + ch.name;
            
            if (Hls.isSupported()) {
                hls.loadSource(url);
                hls.attachMedia(audio);
                hls.on(Hls.Events.MANIFEST_PARSED, () => audio.play());
            } else if (audio.canPlayType('application/vnd.apple.mpegurl')) {
                audio.src = url;
                audio.addEventListener('loadedmetadata', () => audio.play());
            }
        };
        document.getElementById('channelsGrid').appendChild(btn);
    });

    // --- 6. יוטיוב ופלייליסטים (עם שמירה) ---
    const tagsContainer = document.getElementById('tagsContainer');
    const iframe = document.getElementById('youtubeFrame');

    function renderTags() {
        tagsContainer.innerHTML = '';
        config.tags.forEach((tag, idx) => {
            const el = document.createElement('div');
            el.className = 'tag-chip';
            el.innerHTML = `<span>${tag}</span> <i class="fas fa-times" onclick="removeTag(${idx}, event)"></i>`;
            el.onclick = (e) => {
                if(e.target.tagName === 'I') return;
                iframe.src = 'https://www.youtube.com/embed?listType=search&list=' + encodeURIComponent(tag);
            };
            tagsContainer.appendChild(el);
        });
    }

    window.addCustomTag = () => {
        const val = document.getElementById('newTagName').value;
        if(val) {
            config.tags.push(val);
            localStorage.setItem('tags', JSON.stringify(config.tags));
            renderTags();
            document.getElementById('newTagName').value = '';
        }
    }

    window.removeTag = (idx, e) => {
        e.stopPropagation();
        if(confirm('למחוק?')) {
            config.tags.splice(idx, 1);
            localStorage.setItem('tags', JSON.stringify(config.tags));
            renderTags();
        }
    }
    renderTags();

    // --- 7. ערכת נושא ---
    function toggleTheme() {
        config.theme = config.theme === 'light' ? 'dark' : 'light';
        localStorage.setItem('theme', config.theme);
        applyTheme();
    }

    function applyTheme() {
        document.querySelector('.app-wrapper')?.setAttribute('data-theme', config.theme);
        document.documentElement.setAttribute('data-theme', config.theme);
        
        const body = document.body;
        if(config.theme === 'dark') {
            body.style.background = 'linear-gradient(135deg, #2b5876 0%, #4e4376 100%)';
        } else {
            body.style.background = 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)';
        }
    }
    applyTheme(); // החל בטעינה

</script>
</body>
</html>
